name: PR-FRONTMATTER-CHECK

# ãƒˆãƒªã‚¬ãƒ¼: PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚
on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

# Github Runnerã®ã‚·ã‚§ãƒ«
defaults:
  run:
    shell: bash

jobs:
  # FrontMatterãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  frontmatter-check:
    runs-on: ubuntu-latest
    
    steps:
      # PRã®ãƒ–ãƒ©ãƒ³ãƒã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      # è¨˜äº‹ã®å¿…é ˆè¦ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
      - name: Front Matter check
        id: check
        run: |
          er_cnt=0
          error_files=""
          echo "::notice::FrontMatterãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™"
          
          # Authorã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯
          # å¯¾è±¡ã¯ã€_index.mdä»¥å¤–
          echo "::group::Authorã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯"
          for file in $(find ./content/ -name '*.md' | sed -e "/_index.md/d"); do
            tag_author=$(cat $file | sed -ne "/tags \= \[/p" | sed -ne "/Author:/p")
            if [ -z "$tag_author" ]; then
              echo "::error file=$file::Authorã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              error_files="$error_files\n- âŒ **$file**: Authorã‚¿ã‚°ãŒä¸è¶³"
              er_cnt=$(expr $er_cnt + 1)
            else
              echo "::notice file=$file::Authorã‚¿ã‚°: OK"
            fi
          done
          echo "::endgroup::"
          
          # Levelã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯
          # å¯¾è±¡ã¯ã€_index.mdä»¥å¤–ã€Generalãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ã€Otherãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ã€tutorialãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ã€projectsãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–
          echo "::group::Levelã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯"
          for file in $(find ./content/ -name '*.md' | sed -e "/_index.md/d" | sed -e "/content\/general/d" | sed -e "/content\/other/d" | sed -e "/content\/tutorial/d" | sed -e "/content\/projects/d" ); do
            tag_level=$(cat $file | sed -ne "/tags \= \[/p" | sed -ne "/Level:/p")
            if [ -z "$tag_level" ]; then
              echo "::error file=$file::Levelã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              error_files="$error_files\n- âŒ **$file**: Levelã‚¿ã‚°ãŒä¸è¶³"
              er_cnt=$(expr $er_cnt + 1)
            else
              echo "::notice file=$file::Levelã‚¿ã‚°: OK"
            fi
          done
          echo "::endgroup::"
          
          # Typeã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯
          # å¯¾è±¡ã¯ã€_index.mdä»¥å¤–ã€Generalãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ã€tutorialãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–
          echo "::group::Typeã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯"
          for file in $(find ./content/ -name '*.md' | sed -e "/_index.md/d" | sed -e "/content\/general/d" | sed -e "/content\/tutorial/d"); do
            tag_type=$(cat $file | sed -ne "/tags \= \[/p" | sed -ne "/Type:/p")
            if [ -z "$tag_type" ]; then
              echo "::error file=$file::Typeã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              error_files="$error_files\n- âŒ **$file**: Typeã‚¿ã‚°ãŒä¸è¶³"
              er_cnt=$(expr $er_cnt + 1)
            else
              echo "::notice file=$file::Typeã‚¿ã‚°: OK"
            fi
          done
          echo "::endgroup::"
          
          # ã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’GitHub Outputã«ä¿å­˜
          {
            echo 'error_files<<EOF'
            echo -e "$error_files"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
          
          # ã‚¨ãƒ©ãƒ¼æ•°ã‚’GitHub Outputã«ä¿å­˜
          echo "error_count=$er_cnt" >> "$GITHUB_OUTPUT"
          
          # ãƒã‚§ãƒƒã‚¯çµæœã®è¡¨ç¤º
          if [ $er_cnt -eq 0 ]; then
            echo "::notice::âœ… ã™ã¹ã¦ã®FrontMatterãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
            exit 0
          else
            echo "::error::âŒ $er_cnt å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã“ã®PRã¯ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚"
            echo "::error::å•é¡Œã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
            echo -e "$error_files"
            exit 1
          fi

      # ãƒã‚§ãƒƒã‚¯çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
              check_name: 'frontmatter-check'
            });
            
            const success = '${{ steps.check.outcome }}' === 'success';
            const errorCount = '${{ steps.check.outputs.error_count }}';
            const errorFiles = `${{ steps.check.outputs.error_files }}`;
            
            let body;
            if (success) {
              body = 'âœ… **FrontMatterãƒã‚§ãƒƒã‚¯: æˆåŠŸ**\n\nã™ã¹ã¦ã®å¿…é ˆã‚¿ã‚°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®PRã¯ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚';
            } else {
              body = `âŒ **FrontMatterãƒã‚§ãƒƒã‚¯: å¤±æ•—**\n\n**${errorCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«**ã§å¿…é ˆã‚¿ã‚°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\n\nâš ï¸ **ã“ã®PRã¯ç¾åœ¨ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚** ä»¥ä¸‹ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š\n\n### ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«\n${errorFiles}\n\n### ğŸ“‹ å¿…é ˆã‚¿ã‚°ã®èª¬æ˜\n- **Author:** ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦\n- **Level:** server, network, cloudã‚«ãƒ†ã‚´ãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦\n- **Type:** general, tutorialä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦\n\n### ğŸ’¡ ä¿®æ­£ä¾‹\n\`\`\`toml\ntags = ["Author:ã‚ãªãŸã®åå‰", "Level:åˆç´š", "Type:Knowledge"]\n\`\`\`';
            }
            
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('FrontMatterãƒã‚§ãƒƒã‚¯')
            );
            
            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }

      # FrontMatterãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ãŸå ´åˆã€PRã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
      - name: Close PR on failure
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const errorCount = '${{ steps.check.outputs.error_count }}';
            const errorFiles = `${{ steps.check.outputs.error_files }}`;
            
            // PRã‚’ã‚¯ãƒ­ãƒ¼ã‚º
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: context.payload.pull_request.number,
              state: 'closed'
            });
            
            // ã‚¯ãƒ­ãƒ¼ã‚ºç†ç”±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
            const closeMessage = `ğŸš« **PRè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º**\\n\\nã“ã®PRã¯ã€FrontMatterãƒã‚§ãƒƒã‚¯ã®å¤±æ•—ã«ã‚ˆã‚Šè‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚\\n\\n**ğŸ“Š ã‚¨ãƒ©ãƒ¼æ¦‚è¦:**\\n- ã‚¨ãƒ©ãƒ¼æ•°: ${errorCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«\\n- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒãƒ¼ã‚¸è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“\\n\\n**ğŸ”§ ä¿®æ­£å¾Œã®å¯¾å¿œ:**\\n1. ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ã™ã¹ã¦ä¿®æ­£ã—ã¦ãã ã•ã„\\n2. ä¿®æ­£å®Œäº†å¾Œã€æ–°ã—ã„PRã‚’ä½œæˆã—ã¦ãã ã•ã„\\n3. ã¾ãŸã¯ã€ã“ã®PRã‚’å†ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¦ä¿®æ­£ã‚’pushã—ã¦ãã ã•ã„\\n\\n**âš ï¸ æ³¨æ„:**\\nFrontMatterã®å¿…é ˆã‚¿ã‚°ãŒä¸è¶³ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã¯ã€ã‚µã‚¤ãƒˆã®å“è³ªç®¡ç†ä¸Šãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚\\nã™ã¹ã¦ã®å¿…é ˆã‚¿ã‚°ã‚’é©åˆ‡ã«è¨­å®šã—ã¦ã‹ã‚‰å†åº¦PRã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: closeMessage
            });