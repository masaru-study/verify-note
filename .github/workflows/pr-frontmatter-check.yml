name: PR-FRONTMATTER-CHECK

# ãƒˆãƒªã‚¬ãƒ¼: PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚
on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

# PRã®æ“ä½œã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜è¿°ã™ã‚‹ãŸã‚ã®GITHUB_TOKENæ¨©é™
permissions:
  contents: read
  pull-requests: write
  issues: write

# Github Runnerã®ã‚·ã‚§ãƒ«
defaults:
  run:
    shell: bash

jobs:
  # FrontMatterãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  frontmatter-check:
    runs-on: ubuntu-latest

    steps:
      # PRã®ãƒ–ãƒ©ãƒ³ãƒã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      # è¨˜äº‹ã®å¿…é ˆè¦ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
      - name: Front Matter check
        id: check
        continue-on-error: true
        run: |
          # ãƒã‚§ãƒƒã‚¯è¨­å®šã®å®šç¾©ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã®å¿…é ˆã‚¿ã‚°ã‚’æŒ‡å®šï¼‰
          declare -A FOLDER_RULES=(
            ["server"]="Author,Level,Type"
            ["network"]="Author,Level,Type"
            ["cloud"]="Author,Level,Type"
            ["other"]="Author,Type"
            ["projects"]="Author,Type"
          )

          # é¸æŠè‚¢ã®å®šç¾©
          declare -A VALID_OPTIONS=(
            ["Level"]="åˆç´š,ä¸­ç´š,ä¸Šç´š,è¶…ä¸Šç´š,ï¼Ÿï¼Ÿï¼Ÿ"
            ["Type"]="Handson,Knowledge,Minutes"
          )

          # ãƒ•ã‚©ãƒ«ãƒ€ãƒ™ãƒ¼ã‚¹ã®ãƒã‚§ãƒƒã‚¯é–¢æ•°
          check_folder() {
            local folder="$1"
            local required_tags="$2"
            local tag_line
            
            echo "::group::${folder}ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒã‚§ãƒƒã‚¯"
            
            for file in $(find "./content/$folder" -name '*.md' 2>/dev/null | grep -v '_index.md'); do
              for tag_name in $(echo "$required_tags" | tr ',' ' '); do
                tag_pattern="${tag_name}:"
                tag_line=$(cat "$file" | sed -ne "/tags \= \[/p" | sed -ne "/\"${tag_pattern}/p")
                if [ -z "$tag_line" ]; then
                    error_files="$error_files\n- **$file**: ${tag_name}ã‚¿ã‚°ãŒä¸è¶³"
                else
                  if [[ -n "${VALID_OPTIONS[$tag_name]}" ]]; then
                    found_valid=false
                    for opt_name in $(echo "${VALID_OPTIONS[$tag_name]}" | tr ',' ' '); do
                      tag_value=$(echo "$tag_line" | sed -ne "/:${opt_name}\"/p")
                      if [ -n "$tag_value" ]; then found_valid=true; break; fi
                    done
                    if [ "$found_valid" = false ]; then
                      error_files="$error_files\n- **$file**: ${tag_name}ã‚¿ã‚°ã®å€¤ãŒç„¡åŠ¹"
                    fi
                  fi
                fi
              done
            done
            
            echo "::endgroup::"
          }

          # ãƒ¡ã‚¤ãƒ³å‡¦ç†
          error_files=""
          echo "::notice::FrontMatterãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™"

          # å„ãƒ•ã‚©ãƒ«ãƒ€ãƒ«ãƒ¼ãƒ«ã«å¯¾ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
          for folder in "${!FOLDER_RULES[@]}"; do
            required_tags="${FOLDER_RULES[$folder]}"
            check_folder "$folder" "$required_tags"
          done

          # ãƒã‚§ãƒƒã‚¯çµæœã®è¡¨ç¤º
          if [ -z "$error_files" ]; then
            echo "::notice::âœ… ã™ã¹ã¦ã®FrontMatterãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
            exit 0
          else
            echo "::error::âŒ ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã“ã®PRã¯ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚"
            echo "::error::å•é¡Œã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
            echo -e "$error_files"
            {
              echo 'error_files<<EOF'
              echo -e "$error_files"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
            exit 1
          fi

      # FrontMatterãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå ´åˆã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: PR Comment on Success
        if: steps.check.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY=$(cat << "EOF"
          âœ… **FrontMatterãƒã‚§ãƒƒã‚¯: æˆåŠŸ**

          ã™ã¹ã¦ã®å¿…é ˆã‚¿ã‚°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®PRã¯ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚
          EOF
          )
          echo "$COMMENT_BODY" | gh pr comment ${{ github.event.pull_request.number }} --body-file=-

      # FrontMatterãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ãŸå ´åˆã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: PR Comment on Failure
        if: steps.check.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY=$(cat << "EOF"
          âŒ **FrontMatterãƒã‚§ãƒƒã‚¯: å¤±æ•—**
          âš ï¸ ã“ã®PRã¯ç¾åœ¨ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

          ### ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«
          ${{ steps.check.outputs.error_files }}

          ### ğŸ“‹ å¿…é ˆã‚¿ã‚°ã®èª¬æ˜
          - **Author:** ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦
          - **Level:** server, network, cloudã‚«ãƒ†ã‚´ãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦
          - **Type:** general, tutorialä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦

          ### ğŸ’¡ ä¿®æ­£ä¾‹
          ```toml
          tags = [\"Author:ã‚ãªãŸã®åå‰\", \"Level:åˆç´š\", \"Type:Knowledge\"]
          ```

          ### ğŸ”§ ä¿®æ­£å¾Œã®å¯¾å¿œ
          1. ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ã™ã¹ã¦ä¿®æ­£ã—ã¦ãã ã•ã„
          2. ä¿®æ­£å®Œäº†å¾Œã€æ–°ã—ã„PRã‚’ä½œæˆã—ã¦ãã ã•ã„
          3. ã¾ãŸã¯ã€ã“ã®PRã‚’å†ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¦ä¿®æ­£ã‚’pushã—ã¦ãã ã•ã„
          EOF
          )
          echo "$COMMENT_BODY" | gh pr comment ${{ github.event.pull_request.number }} --body-file=-

      # FrontMatterãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ãŸå ´åˆã€PRã‚’ã‚¯ãƒ­ãƒ¼ã‚º
      - name: PR Close on Failure
        if: steps.check.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš« **PRè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚**" | gh pr comment ${{ github.event.pull_request.number }} --body-file=-
          gh pr close ${{ github.event.pull_request.number }}
