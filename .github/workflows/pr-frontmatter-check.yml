name: PR-FRONTMATTER-CHECK

# ãƒˆãƒªã‚¬ãƒ¼: PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚
on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

# PRã®æ“ä½œã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜è¿°ã™ã‚‹ãŸã‚ã®GITHUB_TOKENæ¨©é™
permissions:
  contents: read
  pull-requests: write
  issues: write

# Github Runnerã®ã‚·ã‚§ãƒ«
defaults:
  run:
    shell: bash

jobs:
  # FrontMatterãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  frontmatter-check:
    runs-on: ubuntu-latest

    steps:
      # PRã®ãƒ–ãƒ©ãƒ³ãƒã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      # è¨˜äº‹ã®å¿…é ˆè¦ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
      - name: Front Matter check
        id: check
        continue-on-error: true
        run: |
          error_files=""
          echo "::notice::FrontMatterãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™"

          # Authorã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯
          # å¯¾è±¡ã¯ã€_index.mdä»¥å¤–
          echo "::group::Authorã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯"
          for file in $(find ./content/ -name '*.md' | sed -e "/_index.md/d"); do
            tag_author=$(cat $file | sed -ne "/tags \= \[/p" | sed -ne "/Author:/p")
            if [ -z "$tag_author" ]; then
              echo "::error file=$file::Authorã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              error_files="$error_files\n- âŒ **$file**: Authorã‚¿ã‚°ãŒä¸è¶³"
            else
              echo "::notice file=$file::Authorã‚¿ã‚°: OK"
            fi
          done
          echo "::endgroup::"

          # Levelã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯
          # å¯¾è±¡ã¯ã€_index.mdä»¥å¤–ã€Generalãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ã€Otherãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ã€tutorialãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ã€projectsãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–
          echo "::group::Levelã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯"
          for file in $(find ./content/ -name '*.md' | sed -e "/_index.md/d" | sed -e "/content\/general/d" | sed -e "/content\/other/d" | sed -e "/content\/tutorial/d" | sed -e "/content\/projects/d" ); do
            tag_level=$(cat $file | sed -ne "/tags \= \[/p" | sed -ne "/Level:/p")
            if [ -z "$tag_level" ]; then
              echo "::error file=$file::Levelã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              error_files="$error_files\n- âŒ **$file**: Levelã‚¿ã‚°ãŒä¸è¶³"
            else
              echo "::notice file=$file::Levelã‚¿ã‚°: OK"
            fi
          done
          echo "::endgroup::"

          # Typeã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯
          # å¯¾è±¡ã¯ã€_index.mdä»¥å¤–ã€Generalãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ã€tutorialãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–
          echo "::group::Typeã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯"
          for file in $(find ./content/ -name '*.md' | sed -e "/_index.md/d" | sed -e "/content\/general/d" | sed -e "/content\/tutorial/d"); do
            tag_type=$(cat $file | sed -ne "/tags \= \[/p" | sed -ne "/Type:/p")
            if [ -z "$tag_type" ]; then
              echo "::error file=$file::Typeã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              error_files="$error_files\n- âŒ **$file**: Typeã‚¿ã‚°ãŒä¸è¶³"
            else
              echo "::notice file=$file::Typeã‚¿ã‚°: OK"
            fi
          done
          echo "::endgroup::"

          # ãƒã‚§ãƒƒã‚¯çµæœã®è¡¨ç¤º
          if [ -z ${error_files} ]; then
            echo "::notice::âœ… ã™ã¹ã¦ã®FrontMatterãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
            exit 0
          else
            echo "::error::âŒ ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã“ã®PRã¯ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚"
            echo "::error::å•é¡Œã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
            echo -e "$error_files"
            {
              echo 'error_files<<EOF'
              echo -e "$error_files"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
            exit 1
          fi

      # FrontMatterãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå ´åˆã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: PR Comment on Success
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY=$(cat << "EOF"
          âœ… **FrontMatterãƒã‚§ãƒƒã‚¯: æˆåŠŸ**

          ã™ã¹ã¦ã®å¿…é ˆã‚¿ã‚°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®PRã¯ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚
          EOF
          echo "$COMMENT_BODY" | gh pr comment ${{ github.event.pull_request.number }} --body-file=-

      # FrontMatterãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ãŸå ´åˆã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: PR Comment on Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY=$(cat << "EOF"
          âŒ **FrontMatterãƒã‚§ãƒƒã‚¯: å¤±æ•—**
          âš ï¸ ã“ã®PRã¯ç¾åœ¨ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

          ### ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«
          ${{ steps.check.outputs.error_files }}

          ### ğŸ“‹ å¿…é ˆã‚¿ã‚°ã®èª¬æ˜
          - **Author:** ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦
          - **Level:** server, network, cloudã‚«ãƒ†ã‚´ãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦
          - **Type:** general, tutorialä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦

          ### ğŸ’¡ ä¿®æ­£ä¾‹
          ```toml
          tags = [\"Author:ã‚ãªãŸã®åå‰\", \"Level:åˆç´š\", \"Type:Knowledge\"]
          ```

          ### ğŸ”§ ä¿®æ­£å¾Œã®å¯¾å¿œ
          1. ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ã™ã¹ã¦ä¿®æ­£ã—ã¦ãã ã•ã„
          2. ä¿®æ­£å®Œäº†å¾Œã€æ–°ã—ã„PRã‚’ä½œæˆã—ã¦ãã ã•ã„
          3. ã¾ãŸã¯ã€ã“ã®PRã‚’å†ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¦ä¿®æ­£ã‚’pushã—ã¦ãã ã•ã„

          ğŸš« **PRè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚**
          EOF
          echo "$COMMENT_BODY" | gh pr comment ${{ github.event.pull_request.number }} --body-file=-
          gh pr close ${{ github.event.pull_request.number }}
